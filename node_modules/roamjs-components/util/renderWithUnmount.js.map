{"version":3,"file":"renderWithUnmount.js","sourceRoot":"","sources":["../../src/util/renderWithUnmount.ts"],"names":[],"mappings":";;;AAAA,0DAA0B;AAC1B,kEAAiC;AACjC,oGAA4E;AAE5E,sFAAsD;AACtD,sFAAsD;AAEtD,MAAM,iBAAiB,GAAG,CACxB,EAAsB,EACtB,CAAc,EACd,IAAiB,EACH,EAAE;IAChB,MAAM,WAAW,GAAG,CAAC,CAAC,QAAQ,CAAC;IAC/B,mBAAQ,CAAC,MAAM,CACb,eAAK,CAAC,aAAa,CAAC,6BAA2B,EAAE,IAAI,EAAE,EAAE,CAAC,EAC1D,CAAC,CACF,CAAC;IACF,MAAM,OAAO,GAAG,CAAC,QAA0B,EAAE,EAAE;QAC7C,QAAQ,CAAC,UAAU,EAAE,CAAC;QACtB,mBAAQ,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC;QACnC,IAAA,4BAAkB,EAAC;YACjB,UAAU,EAAE,CAAC,CAAC,CAAC;YACf,SAAS,EAAE,CAAC,QAAQ,CAAC;SACtB,CAAC,CAAC;QACH,IAAI,WAAW,CAAC,MAAM,IAAI,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE;YACnD,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;SAC1D;IACH,CAAC,CAAC;IACF,MAAM,eAAe,GAAG,IAAI,gBAAgB,CAAC,CAAC,EAAE,EAAE,QAAQ,EAAE,EAAE;QAC5D,MAAM,UAAU,GAAW,EAAE,CAAC;QAC9B,MAAM,aAAa,GAAG,EAAE;aACrB,OAAO,CAAC,CAAC,CAAC,EAAE,EAAE;YACb,UAAU,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC;YAC7C,OAAO,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,YAAY,CAAC,CAAC;QACpC,CAAC,CAAC;aACD,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;QACzC,IAAI,aAAa,EAAE;YACjB,MAAM,WAAW,GAAG,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;YAC1D,IAAI,CAAC,WAAW;gBAAE,OAAO,CAAC,QAAQ,CAAC,CAAC;SACrC;IACH,CAAC,CAAC,CAAC;IACH,eAAe,CAAC,OAAO,CAAC,QAAQ,CAAC,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;IAC3E,IAAA,4BAAkB,EAAC;QACjB,UAAU,EAAE,CAAC,CAAC,CAAC;QACf,SAAS,EAAE,CAAC,eAAe,CAAC;KAC7B,CAAC,CAAC;IACH,OAAO,GAAG,EAAE,CAAC,OAAO,CAAC,eAAe,CAAC,CAAC;AACxC,CAAC,CAAC;AAEF,kBAAe,iBAAiB,CAAC","sourcesContent":["import React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport ExtensionApiContextProvider from \"../components/ExtensionApiContext\";\nimport { OnloadArgs } from \"../types\";\nimport dispatchToRegistry from \"./dispatchToRegistry\";\nimport removeFromRegistry from \"./removeFromRegistry\";\n\nconst renderWithUnmount = (\n  el: React.ReactElement,\n  p: HTMLElement,\n  args?: OnloadArgs\n): (() => void) => {\n  const oldChildren = p.children;\n  ReactDOM.render(\n    React.createElement(ExtensionApiContextProvider, args, el),\n    p\n  );\n  const unmount = (observer: MutationObserver) => {\n    observer.disconnect();\n    ReactDOM.unmountComponentAtNode(p);\n    removeFromRegistry({\n      reactRoots: [p],\n      observers: [observer],\n    });\n    if (oldChildren.length && document.body.contains(p)) {\n      Array.from(oldChildren).forEach((c) => p.appendChild(c));\n    }\n  };\n  const unmountObserver = new MutationObserver((ms, observer) => {\n    const addedNodes: Node[] = [];\n    const parentRemoved = ms\n      .flatMap((m) => {\n        addedNodes.push(...Array.from(m.addedNodes));\n        return Array.from(m.removedNodes);\n      })\n      .some((n) => n === p || n.contains(p));\n    if (parentRemoved) {\n      const isNodeAdded = addedNodes.some((n) => n.contains(p));\n      if (!isNodeAdded) unmount(observer);\n    }\n  });\n  unmountObserver.observe(document.body, { childList: true, subtree: true });\n  dispatchToRegistry({\n    reactRoots: [p],\n    observers: [unmountObserver],\n  });\n  return () => unmount(unmountObserver);\n};\n\nexport default renderWithUnmount;\n"]}