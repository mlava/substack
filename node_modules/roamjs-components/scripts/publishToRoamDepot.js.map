{"version":3,"file":"publishToRoamDepot.js","sourceRoot":"","sources":["../../src/scripts/publishToRoamDepot.ts"],"names":[],"mappings":"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","sourcesContent":["import fs from \"fs\";\nimport path from \"path\";\nimport axios from \"axios\";\nimport dotenv from \"dotenv\";\nimport { execSync } from \"child_process\";\ndotenv.config();\n\nconst opts = () => ({\n  headers: {\n    Accept: \"application/vnd.github+json\",\n    Authorization: `token ${process.env.GITHUB_TOKEN}`,\n  },\n});\n\nconst publishToRoamDepot = async ({\n  owner = process.env.GITHUB_REPOSITORY_OWNER,\n  repo = path.basename(process.cwd()),\n  branch = repo,\n  proxy = process.env.ROAMJS_PROXY || owner,\n}: {\n  repo?: string;\n  owner?: string;\n  branch?: string;\n  proxy?: string;\n} = {}) => {\n  console.log(\"Attempting to publish to Roam Depot...\");\n  const pr = await axios\n    .get(\n      `https://api.github.com/repos/Roam-Research/roam-depot/pulls?head=${owner}:${branch}`,\n      opts()\n    )\n    .then((r) => r.data[0]?.html_url);\n  const cwd = process.cwd();\n  process.chdir(\"/tmp\");\n  execSync(\n    `git clone https://${owner}:${process.env.GITHUB_TOKEN}@github.com/${owner}/roam-depot.git`,\n    { stdio: \"inherit\" }\n  );\n  process.chdir(\"roam-depot\");\n  const manifestFile = `extensions/${proxy}/${repo.replace(\n    /^roam(js)?-/,\n    \"\"\n  )}.json`;\n  const packageJson = JSON.parse(\n    fs.readFileSync(`${cwd}/package.json`).toString()\n  );\n  const { name: authorName, email: authorEmail } = await axios\n    .get<{ name: string; email: string }>(`https://api.github.com/user`, opts())\n    .then((r) => r.data)\n    .catch(() => packageJson.author || {});\n  execSync(`git config --global user.email \"${authorEmail}\"`, {\n    stdio: \"inherit\",\n  });\n  execSync(`git config --global user.name \"${authorName}\"`, {\n    stdio: \"inherit\",\n  });\n  execSync(`git remote add roam https://github.com/Roam-Research/roam-depot`, {\n    stdio: \"inherit\",\n  });\n  execSync(`git pull roam main --rebase`, { stdio: \"inherit\" });\n  execSync(`git push origin main -f`, { stdio: \"inherit\" });\n  if (pr) {\n    console.log(\"Found existing PR\");\n    execSync(`git checkout ${branch}`, { stdio: \"inherit\" });\n    execSync(`git rebase origin/main`, { stdio: \"inherit\" });\n    const manifest = fs.readFileSync(manifestFile).toString();\n    fs.writeFileSync(\n      manifestFile,\n      manifest.replace(\n        /\"source_commit\": \"[a-f0-9]+\",/,\n        `\"source_commit\": \"${process.env.GITHUB_SHA}\",`\n      )\n    );\n    console.log(\n      \"Editing\",\n      manifestFile,\n      \"from\",\n      manifest,\n      \"to\",\n      process.env.GITHUB_SHA\n    );\n    execSync(\"git add --all\", { stdio: \"inherit\" });\n    execSync(`git commit -m \"Version ${packageJson.version}\"`, {\n      stdio: \"inherit\",\n    });\n    execSync(`git push origin ${branch} -f`, { stdio: \"inherit\" });\n    console.log(`Updated pull request: ${pr}`);\n  } else {\n    console.log(\"Creating new PR\");\n    execSync(`git checkout -b ${branch}`, { stdio: \"inherit\" });\n    if (!fs.existsSync(`extensions/${proxy}`))\n      fs.mkdirSync(`extensions/${proxy}`);\n    const name = repo\n      .replace(/^roam(js)?-/, \"\")\n      .split(\"-\")\n      .map((s) => `${s.slice(0, 1).toUpperCase()}${s.slice(1)}`)\n      .join(\" \");\n    if (fs.existsSync(manifestFile)) {\n      const manifest = fs.readFileSync(manifestFile).toString();\n      fs.writeFileSync(\n        manifestFile,\n        manifest.replace(\n          /\"source_commit\": \"[a-f0-9]+\",/,\n          `\"source_commit\": \"${process.env.GITHUB_SHA}\",`\n        )\n      );\n    } else {\n      fs.writeFileSync(\n        manifestFile,\n        JSON.stringify(\n          {\n            name,\n            short_description:\n              packageJson?.description ||\n              \"Description missing from package json\",\n            author: authorName,\n            tags: packageJson?.tags || [],\n            source_url: `https://github.com/${owner}/${repo}`,\n            source_repo: `https://github.com/${owner}/${repo}.git`,\n            source_commit: process.env.GITHUB_SHA,\n            stripe_account: packageJson.stripe,\n          },\n          null,\n          4\n        ) + \"\\n\"\n      );\n    }\n    const title = `${name}: Version ${packageJson.version}`;\n    execSync(\"git add --all\", { stdio: \"inherit\" });\n    execSync(`git commit -m \"${title}\"`, { stdio: \"inherit\" });\n    execSync(`git push origin ${branch} -f`, { stdio: \"inherit\" });\n    const url = await axios\n      .post(\n        `https://api.github.com/repos/Roam-Research/roam-depot/pulls`,\n        {\n          head: `${owner}:${branch}`,\n          base: \"main\",\n          title,\n        },\n        opts()\n      )\n      .then((r) => r.data.html_url)\n      .catch((e) => Promise.reject(e.response.data || e.message));\n    console.log(`Created pull request: ${url}`);\n  }\n  process.chdir(cwd);\n};\n\nexport default publishToRoamDepot;\n"]}