{"version":3,"file":"ExternalLogin.js","sourceRoot":"","sources":["../../src/components/ExternalLogin.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Button, Icon, Spinner } from \"@blueprintjs/core\";\nimport React, { useState, useCallback } from \"react\";\nimport createBlock from \"../writes/createBlock\";\nimport getBasicTreeByParentUid from \"../queries/getBasicTreeByParentUid\";\nimport idToTitle from \"../util/idToTitle\";\nimport nanoid from \"nanoid\";\nimport CryptoJS from \"crypto-js\";\nimport localStorageGet from \"../util/localStorageGet\";\nimport localStorageSet from \"../util/localStorageSet\";\nimport apiPost from \"../util/apiPost\";\n\nexport type ExternalLoginOptions = {\n  service: string;\n  getPopoutUrl: (state: string) => Promise<string>;\n  getAuthData: (d: string) => Promise<Record<string, string>>;\n  ServiceIcon: React.FunctionComponent<React.SVGAttributes<SVGElement>>;\n};\n\nconst getTargetOrigin = () => {\n  try {\n    // This is for debugging purposes - should probably remove\n    return process.env.CUSTOM_ROAMJS_ORIGIN;\n  } catch {\n    return \"https://roamjs.com\";\n  }\n};\n\nconst ExternalLogin = ({\n  onSuccess,\n  useLocal,\n  parentUid,\n  service,\n  getPopoutUrl,\n  getAuthData,\n  ServiceIcon,\n  loggedIn = false,\n}: {\n  onSuccess: (block: { text: string; uid: string; data: string }) => void;\n  parentUid: string;\n  useLocal?: boolean;\n  loggedIn?: boolean;\n} & ExternalLoginOptions): React.ReactElement => {\n  const targetOrigin = getTargetOrigin();\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(\"\");\n  const onClick = useCallback(() => {\n    const otp = nanoid().replace(/_/g, \"-\");\n    const key = nanoid().replace(/_/g, \"-\");\n    const state = `${service}_${otp}_${key}`;\n    setLoading(true);\n    getPopoutUrl(state)\n      .then((url) => {\n        const width = 600;\n        const height = 525;\n        const left = window.screenX + (window.innerWidth - width) / 2;\n        const top = window.screenY + (window.innerHeight - height) / 2;\n        const loginWindow = window.open(\n          `${url}&state=${state}`,\n          `roamjs:${service}:login`,\n          `left=${left},top=${top},width=${width},height=${height},status=1`\n        );\n        let intervalListener = 0;\n        const processAuthData = (data: string) => {\n          loginWindow?.close?.();\n          getAuthData(data)\n            .then(async (rr) => {\n              const labelUid = window.roamAlphaAPI.util.generateUID();\n              const { label = \"Default Account\", ...rawData } = rr;\n              const oauthData = JSON.stringify(rawData);\n              const account = {\n                text: label,\n                uid: labelUid,\n                data: oauthData,\n                time: new Date().valueOf(),\n              };\n\n              if (useLocal) {\n                const key = `oauth-${service}`;\n                const accounts = JSON.parse(\n                  (localStorageGet(key) as string) || \"[]\"\n                );\n                localStorageSet(key, JSON.stringify([...accounts, account]));\n              } else {\n                const existingTree = getBasicTreeByParentUid(parentUid).find(\n                  (t) => /oauth/i.test(t.text)\n                );\n                const blockUid =\n                  existingTree?.uid ||\n                  (await createBlock({ node: { text: \"oauth\" }, parentUid }));\n                window.roamAlphaAPI.createBlock({\n                  block: { string: label, uid: labelUid },\n                  location: {\n                    \"parent-uid\": blockUid,\n                    order: existingTree?.children?.length || 0,\n                  },\n                });\n\n                const valueUid = window.roamAlphaAPI.util.generateUID();\n                const block = {\n                  string: oauthData,\n                  uid: valueUid,\n                };\n                window.roamAlphaAPI.createBlock({\n                  location: { \"parent-uid\": labelUid, order: 0 },\n                  block,\n                });\n                window.roamAlphaAPI.updateBlock({\n                  block: { open: false, string: \"oauth\", uid: blockUid },\n                });\n              }\n              onSuccess(account);\n            })\n            .finally(() => {\n              window.removeEventListener(\"message\", messageEventListener);\n              window.clearTimeout(intervalListener);\n              setLoading(false);\n            });\n        };\n        const messageEventListener = (e: MessageEvent) => {\n          if (e.origin === targetOrigin && loginWindow) {\n            processAuthData(e.data);\n          }\n        };\n        const authInterval = () => {\n          apiPost<{ auth: string }>({\n            path: \"auth\",\n            data: {\n              service,\n              otp,\n            },\n            anonymous: true,\n          })\n            .then((r) => {\n              if (r.auth) {\n                const auth = CryptoJS.AES.decrypt(r.auth, key).toString(\n                  CryptoJS.enc.Utf8\n                );\n                processAuthData(auth);\n              } else {\n                intervalListener = window.setTimeout(authInterval, 1000);\n              }\n            })\n            .catch((e) => {\n              if (e.response?.status !== 400) {\n                intervalListener = window.setTimeout(authInterval, 1000);\n              }\n            });\n        };\n        authInterval();\n        window.addEventListener(\"message\", messageEventListener);\n      })\n      .catch((e) => {\n        setError(e.message);\n        setLoading(false);\n      });\n  }, [onSuccess, parentUid, setLoading, setError]);\n  return (\n    <div style={{ display: \"flex\" }}>\n      <Button\n        icon={\n          <Icon\n            icon={\n              <ServiceIcon\n                style={{\n                  width: 15,\n                  height: 15,\n                  marginLeft: 4,\n                  cursor: \"pointer\",\n                }}\n              />\n            }\n          />\n        }\n        onClick={onClick}\n        disabled={loading}\n        className={\"roamjs-external-login\"}\n        rightIcon={loading && <Spinner size={Spinner.SIZE_SMALL} />}\n      >\n        {loggedIn\n          ? `Add Another ${idToTitle(service)} Account`\n          : `Login With ${idToTitle(service)}`}\n      </Button>\n      {error && (\n        <div style={{ color: \"red\", whiteSpace: \"pre-line\" }}>{error}</div>\n      )}\n    </div>\n  );\n};\n\nexport default ExternalLogin;\n"]}